--[[
SENSATION.CC - Fixed Toggle Menu System
Исправлено мигание меню
--]]

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- A. Глобальные переменные
local mainGUI = nil
local mainFrame = nil
local isMenuVisible = false
local inputConnection = nil
local lastToggleTime = 0

-- B. Создание GUI интерфейса
local function CreateMainGUI()
    mainGUI = Instance.new("ScreenGui")
    mainFrame = Instance.new("Frame")
    local titleLabel = Instance.new("TextLabel")
    
    mainGUI.Name = "SensationCC"
    mainGUI.Enabled = false
    mainGUI.Parent = game.CoreGui
    
    mainFrame.Size = UDim2.new(0, 500, 0, 400)
    mainFrame.Position = UDim2.new(0.5, -250, 0.5, -200)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 1
    mainFrame.BorderColor3 = Color3.fromRGB(80, 80, 80)
    mainFrame.Parent = mainGUI
    
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Text = "SENSATION.CC"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 14
    titleLabel.Parent = mainFrame

    return mainGUI
end

-- C. Исправленная система переключения
local function SetupToggleSystem()
    -- 1. Отключаем старые соединения если есть
    if inputConnection then
        inputConnection:Disconnect()
        inputConnection = nil
    end

    -- 2. Функция переключения с защитой от спама
    local function ToggleMenu()
        -- Защита от частых переключений (дебаунс)
        local currentTime = tick()
        if currentTime - lastToggleTime < 0.3 then
            return
        end
        lastToggleTime = currentTime
        
        isMenuVisible = not isMenuVisible
        mainGUI.Enabled = isMenuVisible
        
        if isMenuVisible then
            print("SENSATION.CC Menu: OPENED")
        else
            print("SENSATION.CC Menu: CLOSED")
        end
    end

    -- 3. Единый обработчик событий
    inputConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        -- Проверяем что нажата клавиша Delete и не в текстовом поле
        if input.KeyCode == Enum.KeyCode.Delete then
            if not gameProcessed then
                ToggleMenu()
            end
        end
    end)
end

-- D. Упрощенная RageBot система
local RageBot = {
    Enabled = true,
    AimBot = {Enable = true, FOVRange = 50}
}

local function SetupAimBot()
    RunService.Heartbeat:Connect(function()
        if not RageBot.Enabled then return end
        -- Базовая логика прицеливания
    end)
end

-- E. Инициализация с улучшенной обработкой ошибок
local function InitializeCheat()
    -- 1. Создаем GUI
    CreateMainGUI()
    
    -- 2. Ждем немного перед настройкой переключения
    wait(0.5)
    
    -- 3. Настраиваем систему переключения
    SetupToggleSystem()
    
    -- 4. Запускаем системы
    SetupAimBot()
    
    print("SENSATION.CC successfully loaded! Press DEL to toggle menu")
end

-- F. Запуск с защитой
local success, errorMessage = pcall(InitializeCheat)

if not success then
    warn("SENSATION.CC Load Error: " .. tostring(errorMessage))
    
    -- Попытка восстановления
    local function SafeRetry()
        if mainGUI then
            mainGUI:Destroy()
            mainGUI = nil
        end
        wait(1)
        InitializeCheat()
    end
    
    pcall(SafeRetry)
end
